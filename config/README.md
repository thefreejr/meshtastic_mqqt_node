# Конфигурация Meshtastic MQTT Node Simulator

Эта директория содержит все настройки проекта.

## Структура

- **`project.yaml`** - Настройки проекта (TCP, MQTT, логирование, константы, конфигурация узла)
- **`node_defaults.json`** - Дефолтные настройки ноды (channels, config, module_config, owner)
- **`node_id_mapping.json`** - Объединенный маппинг для сохранения настроек между переподключениями (создается автоматически)
  - `device_id` - маппинг device_id -> node_id
  - `ip` - маппинг IP -> node_id (временная идентификация)
- **`nodes/`** - Индивидуальные настройки нод
  - **`node_!NODEID.json`** - Настройки конкретной ноды (создаются автоматически)

## Файлы конфигурации

### project.yaml

Содержит настройки всего проекта:
- TCP сервер (host, port)
- MQTT настройки по умолчанию
- Логирование (уровень, категории, файл)
- Константы (StreamAPI, Channels, Hop)
- Конфигурация узла (имена, hardware модель, device metrics, firmware version)

### node_defaults.json

Содержит **все** дефолтные настройки ноды:
- `channels` - массив из 8 каналов (index 0-7)
  - Канал 0: PRIMARY, "LongFast", включен
  - Каналы 1-7: DISABLED, выключены
- `config` - protobuf Config (сериализован в base64)
  - Device, LoRa, Position, Power, Display, Network, Bluetooth настройки
- `module_config` - protobuf ModuleConfig (сериализован в base64)
  - MQTT, Serial, Telemetry, CannedMessage и другие модули
- `owner` - protobuf User (сериализован в base64, обычно null)

**Важно:** Все дефолтные настройки хранятся в этом файле. Код не содержит дефолтных значений - они загружаются только из файла.

Если файл не существует, он будет создан автоматически при первом запуске с дефолтными настройками.

### node_id_mapping.json

Объединенный файл маппингов для сохранения настроек между переподключениями и перезапусками сервера.
Создается автоматически при первом подключении клиента.

**Формат:**
```json
{
  "device_id": {
    "device_id_hex": "!NODEID",
    ...
  },
  "ip": {
    "192.168.1.100": "!NODEID",
    ...
  }
}
```

**Секции:**
- `device_id` - постоянный маппинг между `device_id` (уникальный идентификатор устройства) и `node_id`
- `ip` - временный маппинг между IP адресом клиента и `node_id` (используется до получения device_id)

**Миграция:** При первом запуске после обновления, старые файлы `device_id_mapping.json` и `ip_to_node_id_mapping.json` автоматически мигрируют в объединенный файл.

### nodes/node_!NODEID.json

Индивидуальные настройки для каждой ноды (создаются автоматически при сохранении настроек):
- `channels` - каналы ноды
- `config` - конфигурация ноды
- `module_config` - конфигурация модулей ноды
- `owner` - владелец ноды
- `canned_messages` - шаблонные сообщения

## Изменение настроек

1. **Настройки проекта**: Отредактируйте `project.yaml` и перезапустите симулятор
2. **Дефолтные настройки ноды**: Отредактируйте `node_defaults.json` (или удалите файл для пересоздания с текущими дефолтами)
3. **Индивидуальные настройки ноды**: Настройки сохраняются автоматически при изменении через клиент

## Миграция старых настроек

Если у вас есть старые файлы `node_settings.json` или `node_settings_!NODEID.json` в корне проекта, они больше не используются.
Новые настройки сохраняются в `config/nodes/node_!NODEID.json`.

**Примечание:** Старые файлы можно безопасно удалить, так как они больше не читаются кодом.

